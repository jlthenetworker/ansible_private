---
- name: Shutdown VM and Remove it from Proxmox
  hosts: all
  tasks:

    - name: Shutdown VM
      community.general.proxmox_kvm:
        node: "{{ proxmox_node }}"
        api_user: "{{ proxmox_user}}"
        api_password: "{{ proxmox_pass }}"
        api_host: "{{ proxmox_host }}"
        name: "{{ vm_name }}"
        state: stopped
        
    - name: wait 20 seconds
      ansible.builtin.pause:
        seconds: 20

    - name: Remove VM
      community.general.proxmox_kvm:
        node: "{{ proxmox_node }}"
        api_user: "{{ proxmox_user }}"
        api_password: "{{ proxmox_pass }}"
        api_host: "{{ proxmox_host }}"
        name: "{{ vm_name }}"
        state: absent